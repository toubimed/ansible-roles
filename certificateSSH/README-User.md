Generating a User Certificate
------------

To authenticate a user to a remote host, a public key must be generated by the user, passed to the Jenkins job certificateSSH, signed by the CA private key, and then passed back to be stored by the user for use when logging in to a host.

1] On client systems, login as the user who requires the certificate. If public key exists then skip to step 2. Check for available keys as follows:

    ~]$ ls -l ~/.ssh/

If no suitable public key exists, generate one and set the directory permissions if the directory is not the default directory. For example, enter the following command:

    ~]$ ssh-keygen -t rsa
    Generating public/private rsa key pair.
    Enter file in which to save the key (/home/user1/.ssh/id_rsa):
    Created directory '/home/user1/.ssh'.
    Enter passphrase (empty for no passphrase):
    Enter same passphrase again:
    Your identification has been saved in /home/user1/.ssh/id_rsa.
    Your public key has been saved in /home/user1/.ssh/id_rsa.pub.
    The key fingerprint is:
    b1:f8:26:a7:46:87:c3:60:54:a3:6d:85:0d:60:fe:ce user1@host1.example.com
    The key's randomart image is:
    +--[ RSA 2048]----+
    |    oo++.        |
    |   o.o.o.        |
    |   .o o .        |
    |    oo . o       |
    |   . oo.S        |
    |     o=..        |
    |     .Eo+        |
    |      .=         |
    |     ..          |
    +-----------------+
By default the directory permissions for a user's keys are drwx------., or octal 0700. If required, confirm the permissions are correct:

    ~]$ ls -la ~/.ssh
    total 16
    drwx------. 2 user1 user1 4096 May  7 12:37 .
    drwx------. 3 user1 user1 4096 May  7 12:37 ..
    -rw-------. 1 user1 user1 1679 May  7 12:37 id_rsa
    -rw-r--r--. 1 user1 user1  421 May  7 12:37 id_rsa.pub

2] Create new issue Engineering (INFRA) in [Jira](https://jira.x-hub.io/): The chosen public key must be attached with the isssue.

3] Download the resulting certificate (id_rsa-cert.pub) to the user's ~/.ssh/ directory on their system and ensure ensure the permission of id_rsa-cert.pub its 600.

5] If using the standard file names and location then no further configuration is required as the SSH daemon will search for user certificates ending in -cert.pub and use them automatically if it finds them. If you use these locations and naming conventions then there is no need for editing the configuration files to enable sshd to present the certificate. They will be used automatically when logging in to a remote system. In this is the case then skip to step 6.
If required to use a non-default directory or file naming convention, then as root, add the following line to the /etc/ssh/ssh_config or ~/.ssh/config files:

    IdentityFile ~/path/key_file

This will enable the user of this system to be authenticated by a user certificate when logging into a remote system configured to trust the CA user certificate signing key.

6] To test the user certificate, attempt to log into a server over SSH from the user's account. You should do this as the user listed as a principle in the certificate, if any are specified. You should not be prompted for a password. If required, add the -v option to the SSH command to see logging information.
